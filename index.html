<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Test Page</title>

  <script type="text/javascript">
    (function (d, g, t, i, e, s) {
      var o = d["digities"] = d["digities"] || {};
      d[e] = d[e] || function () {
        (o.q = o.q || []).push(arguments);
      };
      var cdn_url = "https://cdn.digities.tech/AeqbSb/id-test-WEBSITE-56069748";

      s = g.createElement(t);
      s.async = true;
      s.src = cdn_url;

      s.onload = function () {
        console.log("Publisher SDK loaded");  
        if (window.Publisher && window.Publisher.getInstance) {
          window.Publisher.getInstance().then(function (instance) {
            o.init = function () {
              console.log("Publisher instance initialized");
              return instance;
            };

            if (o.q) {
              o.q.forEach(function (args) {
                o.init.apply(o, args);
              });
              o.q = [];
            }

            // Check periodically for window.get_dwid and then wait 2 seconds
            var checkInterval = setInterval(function() {
              if (window.get_dwid && typeof window.get_dwid === 'function') {
                clearInterval(checkInterval);
                console.log("window.get_dwid found, waiting 2 seconds...");
                
                // Wait 2 seconds after function is available
                setTimeout(function () {
                  var resultElement = document.getElementById("dwid-result");
                  console.log("Calling window.get_dwid()...");
                  
                  try {
                    var dwid = window.get_dwid();
                    console.log("Result:", dwid);
                    
                    // Check if it's a Promise
                    if (dwid && typeof dwid.then === 'function') {
                      console.log("Result is a Promise, waiting...");
                      dwid.then(function(result) {
                        console.log("Promise resolved:", result);
                        if (resultElement) {
                          resultElement.textContent = typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result);
                        }
                      }).catch(function(error) {
                        console.error("Promise rejected:", error);
                        if (resultElement) {
                          resultElement.textContent = "Error: " + error;
                        }
                      });
                    } else {
                      // It's not a Promise, display directly
                      console.log("Result is not a Promise, displaying directly");
                      if (resultElement) {
                        resultElement.textContent = typeof dwid === 'object' ? JSON.stringify(dwid, null, 2) : String(dwid);
                      }
                    }
                  } catch (error) {
                    console.error("Error calling get_dwid:", error);
                    if (resultElement) {
                      resultElement.textContent = "Error: " + error.message;
                    }
                  }
                }, 2000);
              }
            }, 100);
            
            // Stop checking after 30 seconds
            setTimeout(function() {
              clearInterval(checkInterval);
              var resultElement = document.getElementById("dwid-result");
              if (resultElement && !resultElement.textContent) {
                resultElement.textContent = "window.get_dwid not found after 30 seconds";
              }
            }, 30000);
          });
        }
      };

      e = g.getElementsByTagName(t)[0];
      e.parentNode.insertBefore(s, e);
    })(window, document, "script", "digities");
  </script>
</head>
<body>
  <h1>Test Id</h1>
  <h3 id="dwid-result"></h3>
  
</body>
</html>

